# DocuForge 开发计划

## 项目复杂度分析

DocuForge 是一个基于 AI 的文档重写引擎，具备以下复杂度特征：

1. **AI 工作流复杂度**：三阶段重写算法涉及多轮 LLM 调用和状态管理
2. **数据结构复杂度**：文档结构化表示、嵌套数据验证、序列化处理
3. **错误处理复杂度**：LLM 调用失败、格式验证、重试机制、循环控制
4. **架构复杂度**：LangGraph 状态图、条件边、回调系统
5. **接口复杂度**：CLI 工具、进度反馈、多格式输出

## 开发阶段规划

⚠️ **重要原则**：每个阶段的业务代码开发完成后，必须立即编写配套的单元测试代码。**只有当前阶段的所有单元测试通过后，才能进入下一个阶段**。这确保了代码质量和系统稳定性的递进式提升。

### 第一阶段：基础架构搭建（1-2天）

#### 1.1 项目结构初始化
- [ ] 创建标准 Python 包结构
- [ ] 配置 `pyproject.toml` 和包管理
- [ ] 设置开发环境和依赖管理
- [ ] 建立代码质量工具链（格式化、类型检查）
- [ ] 配置 pytest 测试框架和测试目录结构

**输出**：完整的项目骨架，可运行的基础环境

#### 1.2 核心数据模型实现
- [ ] 基于 Pydantic 实现所有数据类
  - `RewriteRequest`、`RewriteResult`
  - `DocumentStructure`、`DocumentSection`
  - `ClarificationItem`
- [ ] 数据验证和序列化测试
- [ ] JSON 格式兼容性验证

**输出**：完整的数据模型层，包含验证逻辑

#### 1.3 第一阶段单元测试（强制要求）
- [ ] **数据模型单元测试**
  - 所有 Pydantic 模型的创建、验证、序列化测试
  - 边界条件测试（空值、异常数据、格式错误）
  - JSON 互转测试（序列化/反序列化一致性）
- [ ] **测试覆盖率检查**：数据模型相关代码达到 95%+ 覆盖率
- [ ] **测试通过确认**：所有测试用例必须通过，无失败或跳过

**🚫 阻塞条件**：第一阶段单元测试未全部通过时，禁止进入第二阶段

### 第二阶段：核心引擎开发（3-4天）

#### 2.1 基础组件实现
- [ ] `ContextBuilder` - 上下文聚合器
- [ ] `OutlineGenerator` - 大纲生成器（阶段一）
- [ ] `ContentFiller` - 内容填充器（阶段二）
- [ ] `Reviser` - 审核修订器（阶段三）

**输出**：四个核心组件的独立实现

#### 2.2 LangGraph 工作流集成
- [ ] 定义全局状态对象
- [ ] 实现 LangGraph 节点和边
- [ ] 条件边逻辑（修订循环控制）
- [ ] 错误处理和重试机制

**输出**：可工作的 `RewriteChain` 核心引擎

#### 2.3 Prompt 工程和优化
- [ ] 大纲生成 Prompt 设计和测试
- [ ] 内容填充 Prompt（上下文滚动）
- [ ] 审核修订 Prompt（结构化问题输出）
- [ ] Prompt 版本管理和 A/B 测试框架

**输出**：经过优化的 Prompt 模板库

#### 2.4 第二阶段单元测试（强制要求）
- [ ] **核心组件单元测试**
  - `ContextBuilder` 功能测试（上下文聚合逻辑）
  - `OutlineGenerator` 测试（Mock LLM 调用，输出格式验证）
  - `ContentFiller` 测试（上下文滚动逻辑，内容生成流程）
  - `Reviser` 测试（问题识别和修复逻辑）
- [ ] **LangGraph 工作流测试**
  - 状态转换测试（各节点间的数据流）
  - 条件边测试（修订循环控制逻辑）
  - 错误处理测试（LLM 调用失败、重试机制）
- [ ] **Prompt 模板测试**
  - Prompt 模板渲染测试
  - 结构化输出解析测试
- [ ] **集成测试**
  - 端到端三阶段流程测试（使用 Mock LLM）
- [ ] **测试覆盖率检查**：核心引擎代码达到 90%+ 覆盖率
- [ ] **测试通过确认**：所有测试用例必须通过，包括边界情况

**🚫 阻塞条件**：第二阶段单元测试未全部通过时，禁止进入第三阶段

### 第三阶段：用户接口开发（2-3天）

#### 3.1 进度回调系统
- [ ] `ProgressCallbackHandler` 协议实现
- [ ] 阶段进度跟踪和报告
- [ ] CLI 回调处理器实现

**输出**：完整的进度反馈机制

#### 3.2 CLI 工具开发
- [ ] 命令行参数解析（argparse）
- [ ] 文件 I/O 处理
- [ ] 输出格式处理（Markdown、JSON）
- [ ] 错误处理和用户友好提示

**输出**：功能完整的 CLI 工具

#### 3.3 第三阶段单元测试（强制要求）
- [ ] **进度回调系统测试**
  - `ProgressCallbackHandler` 协议实现测试
  - 回调触发时机和数据传递测试
  - CLI 回调处理器输出格式测试
- [ ] **CLI 工具测试**
  - 命令行参数解析测试（正常和异常输入）
  - 文件 I/O 操作测试（读取、写入、权限错误）
  - 输出格式测试（Markdown、JSON 格式正确性）
  - 错误处理测试（文件不存在、格式错误、权限问题）
- [ ] **用户接口集成测试**
  - CLI 端到端流程测试
  - 不同参数组合的功能测试
  - 异常情况的错误提示测试
- [ ] **测试覆盖率检查**：用户接口代码达到 85%+ 覆盖率
- [ ] **测试通过确认**：所有测试用例必须通过，特别是用户交互场景

**🚫 阻塞条件**：第三阶段单元测试未全部通过时，禁止进入第四阶段

### 第四阶段：质量保证和优化（2-3天）

#### 4.1 系统级测试增强
- [ ] 压力测试（大文档处理、长时间运行）
- [ ] 性能基准测试和瓶颈分析
- [ ] 真实 LLM 调用的集成测试
- [ ] 多线程/并发安全性测试

**输出**：经过压力测试的稳定系统

#### 4.2 健壮性增强
- [ ] 错误场景处理完善
- [ ] LLM 调用超时和重试策略优化
- [ ] 内存使用优化（大文档处理）
- [ ] 异常恢复机制完善

**输出**：生产就绪的稳定版本

#### 4.3 可观测性和调试
- [ ] LangSmith 集成和监控
- [ ] 详细日志记录和分级
- [ ] 调试工具和诊断功能
- [ ] 性能监控和优化建议

**输出**：具备完整监控能力的系统

#### 4.4 第四阶段验证测试（强制要求）
- [ ] **系统级验证测试**
  - 完整系统的端到端测试（真实数据、真实 LLM）
  - 性能基准验证（响应时间、内存使用、吞吐量）
  - 稳定性测试（长时间运行、异常情况恢复）
- [ ] **生产环境模拟测试**
  - 各种输入数据的兼容性测试
  - 网络异常、API 限流等场景测试
  - 资源限制环境下的表现测试
- [ ] **全系统测试覆盖率检查**：整体代码覆盖率达到 85%+ 
- [ ] **测试通过确认**：所有测试套件（单元、集成、系统）全部通过
- [ ] **质量门禁检查**：代码质量、性能指标、安全检查全部合格

**✅ 发布条件**：第四阶段所有验证测试通过，系统达到生产环境标准

## 技术风险和缓解策略

### 高风险项
1. **LLM 输出格式不稳定**
   - 缓解：多轮验证 + 格式修复子流程
   - 后备：降级到宽松解析模式

2. **复杂文档的上下文管理**
   - 缓解：分块处理 + 上下文窗口管理
   - 后备：简化版三阶段算法

3. **修订循环的收敛性**
   - 缓解：最大迭代次数限制 + 收敛检测
   - 后备：人工干预接口

### 中风险项
1. **LangGraph 状态管理复杂性** - 通过详细的状态图设计和测试缓解
2. **CLI 用户体验** - 通过用户测试和迭代改进缓解
3. **性能瓶颈** - 通过并发调用和缓存策略缓解

## 里程碑定义

- **MVP 版本**：完成第一、二阶段，可处理简单文档
- **Beta 版本**：完成第三阶段，CLI 工具可用
- **正式版本**：完成第四阶段，生产环境就绪

## 开发资源估算

- **总开发时间**：10-14 个工作日（包含强制单元测试时间）
- **核心开发**：50% 时间（引擎和算法实现）
- **单元测试**：30% 时间（每阶段配套测试，强制要求）
- **工程化**：15% 时间（CLI、打包、部署）
- **质量保证**：5% 时间（最终验证、文档完善）

**测试时间分配**：
- 第一阶段测试：1-1.5 个工作日
- 第二阶段测试：2-2.5 个工作日  
- 第三阶段测试：1-1.5 个工作日
- 第四阶段验证：0.5-1 个工作日

## 交付成果

1. **可安装的 Python 包**：支持 pip 安装
2. **CLI 工具**：`docuforge` 命令行程序
3. **API 接口**：Python 模块导入使用
4. **完整文档**：API 文档、使用指南、最佳实践
5. **测试套件**：单元测试、集成测试、性能测试